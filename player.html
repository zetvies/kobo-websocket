<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Button Grid Player</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #000;
            color: white;
            font-family: Arial, sans-serif;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .status {
            position: fixed;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .grid-cell {
            aspect-ratio: 1;
            background-color: #333;
            border: 2px solid #555;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
        }

        .grid-cell.active {
            background-color: #ff6b6b;
            border-color: #ff5252;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
            transform: scale(1.05);
        }

        .grid-cell.recent {
            background-color: #4ecdc4;
            border-color: #26d0ce;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
        }

        .cell-number {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 12px;
            color: #888;
        }

        .activity-log {
            margin-top: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .log-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
            color: #ccc;
        }

        .log-entry {
            background-color: #222;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            border-left: 4px solid #4ecdc4;
            font-size: 14px;
        }

        .log-entry .timestamp {
            color: #888;
            font-size: 12px;
        }

        .log-entry .button-info {
            color: #4ecdc4;
            font-weight: bold;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .stat-item {
            text-align: center;
            background-color: #222;
            padding: 15px;
            border-radius: 8px;
            min-width: 100px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ecdc4;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .toggle-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .toggle-button {
            background-color: #333;
            color: white;
            border: 2px solid #555;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .toggle-button.active {
            background-color: #4ecdc4;
            border-color: #26d0ce;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
            transform: scale(1.05);
        }

                 .toggle-button.play {
             background-color: #27ae60;
             border-color: #2ecc71;
             box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
         }
 
         .toggle-button.pause {
             background-color: #e74c3c;
             border-color: #c0392b;
             box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
         }
 
         .toggle-button.finish {
             background-color: #9b59b6;
             border-color: #8e44ad;
             box-shadow: 0 0 10px rgba(155, 89, 182, 0.5);
         }

        .toggle-button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div class="status" id="status">Connecting...</div>
    
    <div class="header">
        <h1>Button Grid Player</h1>
        <p>Watch real-time button clicks from the grid</p>
    </div>

         <div class="toggle-container">
         <button class="toggle-button" id="pauseBtn" onclick="setState('pause')">Pause</button>
         <button class="toggle-button" id="playBtn" onclick="setState('play')">Play</button>
         <button class="toggle-button" id="finishBtn" onclick="setState('finish')">Finish</button>
         <button class="toggle-button" onclick="speak('Hello, this is a test of the David voice')" style="background-color: #9b59b6;">Test TTS</button>
     </div>

    <div class="stats">
        <div class="stat-item">
            <div class="stat-value" id="totalClicks">0</div>
            <div class="stat-label">Total Clicks</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="activeConnections">0</div>
            <div class="stat-label">Active Connections</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="lastClick">-</div>
            <div class="stat-label">Last Button</div>
        </div>
    </div>

    <div class="grid-container" id="gridContainer">
        <!-- Grid cells will be generated by JavaScript -->
    </div>

    <div class="activity-log">
        <div class="log-title">Recent Activity</div>
        <div id="logContainer"></div>
    </div>

    <script>
        let ws;
        const statusElement = document.getElementById('status');
        const gridContainer = document.getElementById('gridContainer');
        const logContainer = document.getElementById('logContainer');
        const totalClicksElement = document.getElementById('totalClicks');
        const activeConnectionsElement = document.getElementById('activeConnections');
        const lastClickElement = document.getElementById('lastClick');

        let totalClicks = 0;
        let activeConnections = 0;
        let gridCells = [];
                 let currentState = 'play';

        // Create grid cells
        function createGrid() {
            for (let i = 1; i <= 16; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.id = `cell-${i}`;
                
                const number = document.createElement('div');
                number.className = 'cell-number';
                number.textContent = i;
                
                cell.appendChild(number);
                gridContainer.appendChild(cell);
                gridCells.push(cell);
            }
        }

        // Add log entry
        function addLogEntry(buttonNumber, timestamp) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const time = new Date(timestamp).toLocaleTimeString();
            logEntry.innerHTML = `
                <div class="timestamp">${time}</div>
                <div class="button-info">Button ${buttonNumber} clicked</div>
            `;
            
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Keep only last 10 entries
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Get soothing message based on button number
        function getAffirmativeMessage(buttonNumber) {
            const messages = [
                "Take a deep breath, everything is going to be alright",
                "You are safe and loved",
                "Let go of your worries, just for this moment",
                "You are stronger than you know",
                "Peace is within you",
                "Everything is unfolding exactly as it should",
                "You are enough, just as you are",
                "Trust the journey you're on",
                "You are surrounded by love and light",
                "Breathe in calm, breathe out tension",
                "You are healing and growing",
                "You have everything you need within you",
                "Let peace wash over you",
                "You are worthy of all good things",
                "Everything will be okay in the end",
                "You are a beautiful soul"
            ];
            
            return messages[(buttonNumber - 1) % messages.length];
        }

        // Initialize speech synthesis
        function initSpeechSynthesis() {
            if ('speechSynthesis' in window) {
                // Load voices
                speechSynthesis.getVoices();
                
                // Chrome needs a small delay to load voices
                setTimeout(() => {
                    console.log('Speech synthesis initialized');
                    console.log('Available voices:', speechSynthesis.getVoices().length);
                    
                    // List all available voices for debugging
                    const voices = speechSynthesis.getVoices();
                    voices.forEach((voice, index) => {
                        console.log(`Voice ${index}: ${voice.name} (${voice.lang})`);
                    });
                }, 100);
            }
        }

        // Speak text using Web Speech API
        function speak(text) {
            console.log('Attempting to speak:', text);
            
            if ('speechSynthesis' in window) {
                try {
                    // Stop any current speech
                    speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.75; // Slower for more soothing effect
                    utterance.pitch = 0.9; // Lower pitch for calming tone
                    utterance.volume = 0.7; // Slightly lower volume for gentleness
                    utterance.lang = 'en-US';
                    
                    // Get available voices
                    const voices = speechSynthesis.getVoices();
                    console.log('Available voices:', voices.length);
                    
                    // Try to find David voice specifically
                    let selectedVoice = null;
                    
                    // First, try to find David voice
                    selectedVoice = voices.find(voice => 
                        voice.name.toLowerCase().includes('david') ||
                        voice.name.toLowerCase().includes('microsoft david')
                    );
                    
                    // If David not found, try to find any male voice
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => 
                            voice.name.toLowerCase().includes('male') ||
                            voice.name.toLowerCase().includes('man') ||
                            voice.name.toLowerCase().includes('boy') ||
                            voice.name.toLowerCase().includes('alex') ||
                            voice.name.toLowerCase().includes('daniel') ||
                            voice.name.toLowerCase().includes('mark') ||
                            voice.name.toLowerCase().includes('richard')
                        );
                    }
                    
                    // If no male voice found, use the first available
                    if (!selectedVoice && voices.length > 0) {
                        selectedVoice = voices[0];
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        console.log('Using voice:', selectedVoice.name);
                    }
                    
                    // Add event listeners for debugging
                    utterance.onstart = () => console.log('Speech started');
                    utterance.onend = () => console.log('Speech ended');
                    utterance.onerror = (event) => {
                        console.error('Speech error:', event.error);
                        if (event.error === 'not-allowed') {
                            console.log('Speech blocked - user interaction required. Try clicking the Test TTS button first.');
                        }
                    };
                    
                    speechSynthesis.speak(utterance);
                    console.log('Speech synthesis.speak() called');
                    
                } catch (error) {
                    console.error('Error in speak function:', error);
                }
            } else {
                console.error('Speech synthesis not supported');
            }
        }

        // Animate button click and speak message
        function animateButton(buttonNumber) {
            const cell = document.getElementById(`cell-${buttonNumber}`);
            if (cell) {
                // Remove active class from all cells
                gridCells.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked cell
                cell.classList.add('active');
                
                // Speak affirmative message
                const message = getAffirmativeMessage(buttonNumber);
                speak(message);
                
                // Remove active class after animation
                setTimeout(() => {
                    cell.classList.remove('active');
                    cell.classList.add('recent');
                    
                    // Remove recent class after a delay
                    setTimeout(() => {
                        cell.classList.remove('recent');
                    }, 2000);
                }, 300);
            }
        }

        function connectWebSocket() {
            ws = new WebSocket('wss://kobo-websocket.onrender.com/');

            ws.onopen = function() {
                statusElement.textContent = 'Connected';
                statusElement.style.color = '#00ff00';
                console.log('WebSocket connected');
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Received:', data);
                
                if (data.type === 'button_click') {
                    totalClicks++;
                    totalClicksElement.textContent = totalClicks;
                    lastClickElement.textContent = data.buttonNumber;
                    
                    animateButton(data.buttonNumber);
                    addLogEntry(data.buttonNumber, data.timestamp);
                } else if (data.type === 'connection') {
                    activeConnections++;
                    activeConnectionsElement.textContent = activeConnections;
                                 } else if (data.type === 'state_change') {
                     currentState = data.state;
                     console.log(`State changed to: ${data.state}`);
                     
                     // Update button styles
                     document.querySelectorAll('.toggle-button').forEach(btn => {
                         btn.classList.remove('active', 'play', 'pause', 'finish');
                     });
                     const activeButton = document.getElementById(data.state + 'Btn');
                     activeButton.classList.add('active', data.state);
                     
                                           // Handle finish state
                      if (data.state === 'finish') {
                          // No action needed for finish state in player
                      }
                 }
            };

            ws.onclose = function() {
                statusElement.textContent = 'Disconnected - Reconnecting...';
                statusElement.style.color = '#ff0000';
                console.log('WebSocket disconnected');
                
                // Try to reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = function(error) {
                statusElement.textContent = 'Connection Error';
                statusElement.style.color = '#ff0000';
                console.error('WebSocket error:', error);
            };
        }

                 // Show thank you message
         function showThankYouMessage() {
             // Create overlay
             const overlay = document.createElement('div');
             overlay.style.cssText = `
                 position: fixed;
                 top: 0;
                 left: 0;
                 width: 100vw;
                 height: 100vh;
                 background-color: rgba(0, 0, 0, 0.9);
                 display: flex;
                 justify-content: center;
                 align-items: center;
                 z-index: 10000;
                 font-family: Arial, sans-serif;
             `;
             
             const message = document.createElement('div');
             message.style.cssText = `
                 color: white;
                 font-size: 48px;
                 font-weight: bold;
                 text-align: center;
                 animation: fadeIn 1s ease-in;
             `;
             message.textContent = 'Thank you for playing ;)';
             
             // Add CSS animation
             const style = document.createElement('style');
             style.textContent = `
                 @keyframes fadeIn {
                     from { opacity: 0; transform: scale(0.8); }
                     to { opacity: 1; transform: scale(1); }
                 }
             `;
             document.head.appendChild(style);
             
                           overlay.appendChild(message);
              document.body.appendChild(overlay);
         }
 
         // Set state function
         function setState(state) {
             // Send state to WebSocket
             if (ws && ws.readyState === WebSocket.OPEN) {
                 const message = {
                     type: 'state_change',
                     state: state
                 };
                 ws.send(JSON.stringify(message));
                 console.log(`Sent state change: ${state}`);
                 
                 // Update button styles immediately for local feedback
                 document.querySelectorAll('.toggle-button').forEach(btn => {
                     btn.classList.remove('active', 'play', 'pause', 'finish');
                 });
                 const activeButton = document.getElementById(state + 'Btn');
                 activeButton.classList.add('active', state);
                 
                                   // Handle finish state locally
                  if (state === 'finish') {
                      // No action needed for finish state in player
                  }
             } else {
                 console.log('WebSocket not connected, cannot send state change');
             }
         }

                 // Initialize
         createGrid();
         connectWebSocket();
         initSpeechSynthesis();
         
                   // Set initial state after connection
          setTimeout(() => {
              setState('play');
          }, 1000);
    </script>
</body>
</html> 